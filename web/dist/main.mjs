(()=>{function f(l,e=5,t=null,s=null,a=navigator.hardwareConcurrency||1){return console.debug("fast algo"),new Promise((o,n)=>{let d=URL.createObjectURL(new Blob(["(",w(),")()"],{type:"application/javascript"})),m=[],u=()=>{m.forEach(i=>i.terminate()),t!=null&&(t.removeEventListener("abort",u),t.aborted&&(console.log("PoW aborted"),n(!1)))};t?.addEventListener("abort",u,{once:!0});for(let i=0;i<a;i++){let r=new Worker(d);r.onmessage=c=>{typeof c.data=="number"?s?.(c.data):(u(),o(c.data))},r.onerror=c=>{u(),n(c)},r.postMessage({data:l,difficulty:e,nonce:i,threads:a}),m.push(r)}URL.revokeObjectURL(d)})}function w(){return function(){let l=t=>{let s=new TextEncoder().encode(t);return crypto.subtle.digest("SHA-256",s.buffer)};function e(t){return Array.from(t).map(s=>s.toString(16).padStart(2,"0")).join("")}addEventListener("message",async t=>{let s=t.data.data,a=t.data.difficulty,o,n=t.data.nonce,d=t.data.threads,m=n;for(;;){let u=await l(s+n),i=new Uint8Array(u),r=!0;for(let p=0;p<a;p++){let y=Math.floor(p/2),h=p%2;if((i[y]>>(h===0?4:0)&15)!==0){r=!1;break}}if(r){o=e(i),console.log(o);break}let c=n;n+=d,n>c|1023&&(n>>10)%d===m&&postMessage(n)}postMessage({hash:o,data:s,difficulty:a,nonce:n})})}.toString()}var g=class{static state={baseURL:"",version:"1.0.0"};static elements={title:null,mascot:null,status:null,metrics:null,message:null,progressContainer:null,progressBar:null};static initialize(e){this.state={...this.state,...e},this.elements={title:document.getElementById("title"),mascot:document.getElementById("mascot"),status:document.getElementById("status"),metrics:document.getElementById("metrics"),message:document.getElementById("message"),progressContainer:document.getElementById("progress-container"),progressBar:document.getElementById("progress-bar")}}static setState(e,t={}){switch(e){case"checking":this.setChecking(t);break;case"success":this.setSuccess(t);break}}static setChecking(e){this.elements.title.textContent=e.title||"Making sure you're not a bot!",this.elements.mascot.src=`${this.state.baseURL}/static/img/mascot-puzzle.png?v=${this.state.version}`,this.elements.status.textContent=e.status||"Calculating...",this.elements.progressContainer.classList.remove("hidden"),this.setCheckingProgress(e.progress,e.metrics,e.message)}static setCheckingProgress(e,t,s){e!==void 0&&(this.elements.progressBar.style.width=`${e}%`),t!==void 0&&(t===""?this.elements.metrics.classList.add("hidden"):(this.elements.metrics.classList.remove("hidden"),this.elements.metrics.textContent=t)),s!==void 0&&(this.elements.message.textContent=s)}static setSuccess(e){this.elements.title.textContent="Success!",this.elements.mascot.src=`${this.state.baseURL}/static/img/mascot-pass.png?v=${this.state.version}`,this.elements.status.textContent=e.status||"Done!",this.elements.metrics.textContent=e.metrics||"Took ?, ? iterations",this.elements.message.textContent=e.message||"",this.elements.progressContainer.classList.add("hidden")}};function C(l,e,t){console.log("post url",`${t}/answer`);let s=document.createElement("form");s.method="POST",s.action=`${t}/answer`;let a=document.createElement("input");a.type="hidden",a.name="response",a.value=l;let o=document.createElement("input");o.type="hidden",o.name="nonce",o.value=e;let n=document.createElement("input");return n.type="hidden",n.name="redir",n.value=window.location.href,console.log("redir value",n.value),s.appendChild(a),s.appendChild(o),s.appendChild(n),document.body.appendChild(s),s}(async()=>{let l=JSON.parse(document.getElementById("challenge").textContent),e=JSON.parse(document.getElementById("difficulty").textContent),t=JSON.parse(document.getElementById("baseURL").textContent),s=JSON.parse(document.getElementById("version").textContent);g.initialize({baseURL:t,version:s}),g.setState("checking",{metrics:`Difficulty: ${e}, Speed: calculating...`,message:""});let a=Date.now(),o=0,n=Math.pow(16,-e),{hash:d,nonce:m}=await f(l,e,null,r=>{let c=Math.pow(1-n,r),p=(1-Math.pow(c,2))*100,h=Date.now()-a;if(console.log("delta",h,"lastUpdate",o,"delta - lastUpdate",h-o),h-o>100){let b=r/h;g.setCheckingProgress(p,`Difficulty: ${e}, Speed: ${b.toFixed(3)}kH/s`,c<.01?"This is taking longer than expected. Please do not refresh the page.":void 0),o=h}}),u=Date.now();console.log({hash:d,nonce:m}),g.setState("success",{status:"Verification Complete!",metrics:`Took ${u-a}ms, ${m} iterations`});let i=C(d,m,t);setTimeout(()=>{i.submit()},250)})();})();
